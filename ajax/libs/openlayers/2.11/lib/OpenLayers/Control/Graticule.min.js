OpenLayers.Control.Graticule=OpenLayers.Class(OpenLayers.Control,{autoActivate:!0,intervals:[45,30,20,10,5,2,1,.5,.2,.1,.05,.01,.005,.002,.001],displayInLayerSwitcher:!0,visible:!0,numPoints:50,targetSize:200,layerName:null,labelled:!0,labelFormat:"dm",lineSymbolizer:{strokeColor:"#333",strokeWidth:1,strokeOpacity:.5},labelSymbolizer:{},gratLayer:null,initialize:function(e){e=e||{},e.layerName=e.layerName||OpenLayers.i18n("Graticule"),OpenLayers.Control.prototype.initialize.apply(this,[e]),this.labelSymbolizer.stroke=!1,this.labelSymbolizer.fill=!1,this.labelSymbolizer.label="${label}",this.labelSymbolizer.labelAlign="${labelAlign}",this.labelSymbolizer.labelXOffset="${xOffset}",this.labelSymbolizer.labelYOffset="${yOffset}"},destroy:function(){this.deactivate(),OpenLayers.Control.prototype.destroy.apply(this,arguments),this.gratLayer&&(this.gratLayer.destroy(),this.gratLayer=null)},draw:function(){if(OpenLayers.Control.prototype.draw.apply(this,arguments),!this.gratLayer){var e=new OpenLayers.Style({},{rules:[new OpenLayers.Rule({symbolizer:{Point:this.labelSymbolizer,Line:this.lineSymbolizer}})]});this.gratLayer=new OpenLayers.Layer.Vector(this.layerName,{styleMap:new OpenLayers.StyleMap({"default":e}),visibility:this.visible,displayInLayerSwitcher:this.displayInLayerSwitcher})}return this.div},activate:function(){return OpenLayers.Control.prototype.activate.apply(this,arguments)?(this.map.addLayer(this.gratLayer),this.map.events.register("moveend",this,this.update),this.update(),!0):!1},deactivate:function(){return OpenLayers.Control.prototype.deactivate.apply(this,arguments)?(this.map.events.unregister("moveend",this,this.update),this.map.removeLayer(this.gratLayer),!0):!1},update:function(){var e=this.map.getExtent();if(e){this.gratLayer.destroyFeatures();var t=new OpenLayers.Projection("EPSG:4326"),i=this.map.getProjectionObject(),n=this.map.getResolution();i.proj&&"longlat"==i.proj.projName&&(this.numPoints=1);var r=this.map.getCenter(),o=new OpenLayers.Pixel(r.lon,r.lat);OpenLayers.Projection.transform(o,i,t);var s=this.targetSize*n;s*=s;for(var a,l=0;this.intervals.length>l;++l){a=this.intervals[l];var c=a/2,u=o.offset(new OpenLayers.Pixel(-c,-c)),h=o.offset(new OpenLayers.Pixel(c,c));OpenLayers.Projection.transform(u,t,i),OpenLayers.Projection.transform(h,t,i);var d=(u.x-h.x)*(u.x-h.x)+(u.y-h.y)*(u.y-h.y);if(s>=d)break}o.x=Math.floor(o.x/a)*a,o.y=Math.floor(o.y/a)*a;var p,f=0,m=[o.clone()],g=o.clone();do g=g.offset(new OpenLayers.Pixel(0,a)),p=OpenLayers.Projection.transform(g.clone(),t,i),m.unshift(g);while(e.containsPixel(p)&&1e3>++f);g=o.clone();do g=g.offset(new OpenLayers.Pixel(0,-a)),p=OpenLayers.Projection.transform(g.clone(),t,i),m.push(g);while(e.containsPixel(p)&&1e3>++f);f=0;var v=[o.clone()];g=o.clone();do g=g.offset(new OpenLayers.Pixel(-a,0)),p=OpenLayers.Projection.transform(g.clone(),t,i),v.unshift(g);while(e.containsPixel(p)&&1e3>++f);g=o.clone();do g=g.offset(new OpenLayers.Pixel(a,0)),p=OpenLayers.Projection.transform(g.clone(),t,i),v.push(g);while(e.containsPixel(p)&&1e3>++f);for(var y=[],l=0;v.length>l;++l){for(var b=v[l].x,x=[],C=null,_=Math.min(m[0].y,90),w=Math.max(m[m.length-1].y,-90),k=(_-w)/this.numPoints,S=w,E=0;this.numPoints>=E;++E){var T=new OpenLayers.Geometry.Point(b,S);T.transform(t,i),x.push(T),S+=k,T.y>=e.bottom&&!C&&(C=T)}if(this.labelled){var L=new OpenLayers.Geometry.Point(C.x,e.bottom),O={value:b,label:this.labelled?OpenLayers.Util.getFormattedLonLat(b,"lon",this.labelFormat):"",labelAlign:"cb",xOffset:0,yOffset:2};this.gratLayer.addFeatures(new OpenLayers.Feature.Vector(L,O))}var P=new OpenLayers.Geometry.LineString(x);y.push(new OpenLayers.Feature.Vector(P))}for(var E=0;m.length>E;++E)if(S=m[E].y,!(-90>S||S>90)){for(var x=[],A=v[0].x,M=v[v.length-1].x,D=(M-A)/this.numPoints,b=A,C=null,l=0;this.numPoints>=l;++l){var T=new OpenLayers.Geometry.Point(b,S);T.transform(t,i),x.push(T),b+=D,T.x<e.right&&(C=T)}if(this.labelled){var L=new OpenLayers.Geometry.Point(e.right,C.y),O={value:S,label:this.labelled?OpenLayers.Util.getFormattedLonLat(S,"lat",this.labelFormat):"",labelAlign:"rb",xOffset:-2,yOffset:2};this.gratLayer.addFeatures(new OpenLayers.Feature.Vector(L,O))}var P=new OpenLayers.Geometry.LineString(x);y.push(new OpenLayers.Feature.Vector(P))}this.gratLayer.addFeatures(y)}},CLASS_NAME:"OpenLayers.Control.Graticule"});