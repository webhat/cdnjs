OpenLayers.Control.TransformFeature=OpenLayers.Class(OpenLayers.Control,{EVENT_TYPES:["beforesetfeature","setfeature","beforetransform","transform","transformcomplete"],geometryTypes:null,layer:null,preserveAspectRatio:!1,rotate:!0,feature:null,renderIntent:"temporary",rotationHandleSymbolizer:null,box:null,center:null,scale:1,ratio:1,rotation:0,handles:null,rotationHandles:null,dragControl:null,initialize:function(e,t){this.EVENT_TYPES=OpenLayers.Control.TransformFeature.prototype.EVENT_TYPES.concat(OpenLayers.Control.prototype.EVENT_TYPES),OpenLayers.Control.prototype.initialize.apply(this,[t]),this.layer=e,this.rotationHandleSymbolizer||(this.rotationHandleSymbolizer={stroke:!1,pointRadius:10,fillOpacity:0,cursor:"pointer"}),this.createBox(),this.createControl()},activate:function(){var e=!1;return OpenLayers.Control.prototype.activate.apply(this,arguments)&&(this.dragControl.activate(),this.layer.addFeatures([this.box]),this.rotate&&this.layer.addFeatures(this.rotationHandles),this.layer.addFeatures(this.handles),e=!0),e},deactivate:function(){var e=!1;return OpenLayers.Control.prototype.deactivate.apply(this,arguments)&&(this.layer.removeFeatures(this.handles),this.rotate&&this.layer.removeFeatures(this.rotationHandles),this.layer.removeFeatures([this.box]),this.dragControl.deactivate(),e=!0),e&&this.unsetFeature(),e},setMap:function(e){this.dragControl.setMap(e),OpenLayers.Control.prototype.setMap.apply(this,arguments)},setFeature:function(e,t){t=OpenLayers.Util.applyDefaults(t,{rotation:0,scale:1,ratio:1});var i=this.rotation,n=this.center;OpenLayers.Util.extend(this,t);var r=this.events.triggerEvent("beforesetfeature",{feature:e});if(r!==!1){this.feature=e,this.activate(),this._setfeature=!0;var o=this.feature.geometry.getBounds();this.box.move(o.getCenterLonLat()),this.box.geometry.rotate(-i,n),this._angle=0;var s;if(this.rotation){var a=e.geometry.clone();a.rotate(-this.rotation,this.center);var l=new OpenLayers.Feature.Vector(a.getBounds().toGeometry());l.geometry.rotate(this.rotation,this.center),this.box.geometry.rotate(this.rotation,this.center),this.box.move(l.geometry.getBounds().getCenterLonLat());var c=l.geometry.components[0].components[0];s=c.getBounds().getCenterLonLat()}else s=new OpenLayers.LonLat(o.left,o.bottom);this.handles[0].move(s),delete this._setfeature,this.events.triggerEvent("setfeature",{feature:e})}},unsetFeature:function(){this.active?this.deactivate():(this.feature=null,this.rotation=0,this.scale=1,this.ratio=1)},createBox:function(){var e=this;this.center=new OpenLayers.Geometry.Point(0,0);var t=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString([new OpenLayers.Geometry.Point(-1,-1),new OpenLayers.Geometry.Point(0,-1),new OpenLayers.Geometry.Point(1,-1),new OpenLayers.Geometry.Point(1,0),new OpenLayers.Geometry.Point(1,1),new OpenLayers.Geometry.Point(0,1),new OpenLayers.Geometry.Point(-1,1),new OpenLayers.Geometry.Point(-1,0),new OpenLayers.Geometry.Point(-1,-1)]),null,"string"==typeof this.renderIntent?null:this.renderIntent);t.geometry.move=function(t,i){e._moving=!0,OpenLayers.Geometry.LineString.prototype.move.apply(this,arguments),e.center.move(t,i),delete e._moving};for(var i,n,r,o=function(e,t){OpenLayers.Geometry.Point.prototype.move.apply(this,arguments),this._rotationHandle&&this._rotationHandle.geometry.move(e,t),this._handle.geometry.move(e,t)},s=function(e,t,i){OpenLayers.Geometry.Point.prototype.resize.apply(this,arguments),this._rotationHandle&&this._rotationHandle.geometry.resize(e,t,i),this._handle.geometry.resize(e,t,i)},a=function(e,t){OpenLayers.Geometry.Point.prototype.rotate.apply(this,arguments),this._rotationHandle&&this._rotationHandle.geometry.rotate(e,t),this._handle.geometry.rotate(e,t)},l=function(t,i){var n=this.x,r=this.y;if(OpenLayers.Geometry.Point.prototype.move.call(this,t,i),!e._moving){var o=e.dragControl.handlers.drag.evt,s=!e._setfeature&&e.preserveAspectRatio,a=!(s||o&&o.shiftKey),l=new OpenLayers.Geometry.Point(n,r),c=e.center;this.rotate(-e.rotation,c),l.rotate(-e.rotation,c);var h=this.x-c.x,u=this.y-c.y,d=h-(this.x-l.x),p=u-(this.y-l.y);this.x=n,this.y=r;var f,m=1;if(a)f=1e-5>Math.abs(p)?1:u/p,m=(1e-5>Math.abs(d)?1:h/d)/f;else{var g=Math.sqrt(d*d+p*p),v=Math.sqrt(h*h+u*u);f=v/g}e._moving=!0,e.box.geometry.rotate(-e.rotation,c),delete e._moving,e.box.geometry.resize(f,c,m),e.box.geometry.rotate(e.rotation,c),e.transformFeature({scale:f,ratio:m})}},c=function(t,i){var n=this.x,r=this.y;if(OpenLayers.Geometry.Point.prototype.move.call(this,t,i),!e._moving){var o=e.dragControl.handlers.drag.evt,s=o&&o.shiftKey?45:1,a=e.center,l=this.x-a.x,c=this.y-a.y,h=l-t,u=c-i;this.x=n,this.y=r;var d=Math.atan2(u,h),p=Math.atan2(c,l),f=p-d;f*=180/Math.PI,e._angle=(e._angle+f)%360;var m=e.rotation%s;(Math.abs(e._angle)>=s||0!==m)&&(f=Math.round(e._angle/s)*s-m,e._angle=0,e.box.geometry.rotate(f,a),e.transformFeature({rotation:f}))}},h=Array(8),u=Array(4),d=0;8>d;++d)i=t.geometry.components[d],n=new OpenLayers.Feature.Vector(i.clone(),null,"string"==typeof this.renderIntent?null:this.renderIntent),0==d%2&&(r=new OpenLayers.Feature.Vector(i.clone(),null,"string"==typeof this.rotationHandleSymbolizer?null:this.rotationHandleSymbolizer),r.geometry.move=c,i._rotationHandle=r,u[d/2]=r),i.move=o,i.resize=s,i.rotate=a,n.geometry.move=l,i._handle=n,h[d]=n;this.box=t,this.rotationHandles=u,this.handles=h},createControl:function(){var e=this;this.dragControl=new OpenLayers.Control.DragFeature(this.layer,{documentDrag:!0,moveFeature:function(){this.feature===e.feature&&(this.feature=e.box),OpenLayers.Control.DragFeature.prototype.moveFeature.apply(this,arguments)},onDrag:function(t){t===e.box&&(e.transformFeature({center:e.center}),e.drawHandles())},onStart:function(t){var i=!e.geometryTypes||-1!==OpenLayers.Util.indexOf(e.geometryTypes,t.geometry.CLASS_NAME),n=OpenLayers.Util.indexOf(e.handles,t);n+=OpenLayers.Util.indexOf(e.rotationHandles,t),t!==e.feature&&t!==e.box&&-2==n&&i&&e.setFeature(t)},onComplete:function(){e.events.triggerEvent("transformcomplete",{feature:e.feature})}})},drawHandles:function(){for(var e=this.layer,t=0;8>t;++t)this.rotate&&0===t%2&&e.drawFeature(this.rotationHandles[t/2],this.rotationHandleSymbolizer),e.drawFeature(this.handles[t],this.renderIntent)},transformFeature:function(e){if(!this._setfeature){this.scale*=e.scale||1,this.ratio*=e.ratio||1;var t=this.rotation;if(this.rotation=(this.rotation+(e.rotation||0))%360,this.events.triggerEvent("beforetransform",e)!==!1){var i=this.feature,n=i.geometry,r=this.center;n.rotate(-t,r),e.scale||e.ratio?n.resize(e.scale,r,e.ratio):e.center&&i.move(e.center.getBounds().getCenterLonLat()),n.rotate(this.rotation,r),this.layer.drawFeature(i),i.toState(OpenLayers.State.UPDATE),this.events.triggerEvent("transform",e)}}this.layer.drawFeature(this.box,this.renderIntent),this.drawHandles()},destroy:function(){for(var e,t=0;8>t;++t)e=this.box.geometry.components[t],e._handle.destroy(),e._handle=null,e._rotationHandle&&e._rotationHandle.destroy(),e._rotationHandle=null;this.box.destroy(),this.box=null,this.layer=null,this.dragControl.destroy(),OpenLayers.Control.prototype.destroy.apply(this,arguments)},CLASS_NAME:"OpenLayers.Control.TransformFeature"});