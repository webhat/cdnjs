OpenLayers.Layer.ArcIMS=OpenLayers.Class(OpenLayers.Layer.Grid,{DEFAULT_PARAMS:{ClientVersion:"9.2",ServiceName:""},tileSize:null,featureCoordSys:"4326",filterCoordSys:"4326",layers:null,async:!0,name:"ArcIMS",isBaseLayer:!0,DEFAULT_OPTIONS:{tileSize:new OpenLayers.Size(512,512),featureCoordSys:"4326",filterCoordSys:"4326",layers:null,isBaseLayer:!0,async:!0,name:"ArcIMS"},initialize:function(e,t,i){this.tileSize=new OpenLayers.Size(512,512),this.params=OpenLayers.Util.applyDefaults({ServiceName:i.serviceName},this.DEFAULT_PARAMS),this.options=OpenLayers.Util.applyDefaults(i,this.DEFAULT_OPTIONS),OpenLayers.Layer.Grid.prototype.initialize.apply(this,[e,t,this.params,i]),this.transparent&&(this.isBaseLayer||(this.isBaseLayer=!1),"image/jpeg"==this.format&&(this.format=OpenLayers.Util.alphaHack()?"image/gif":"image/png")),null===this.options.layers&&(this.options.layers=[])},destroy:function(){OpenLayers.Layer.Grid.prototype.destroy.apply(this,arguments)},getURL:function(e){var t="";e=this.adjustBounds(e);var i=new OpenLayers.Format.ArcXML(OpenLayers.Util.extend(this.options,{requesttype:"image",envelope:e.toArray(),tileSize:this.tileSize})),n=new OpenLayers.Request.POST({url:this.getFullRequestString(),data:i.write(),async:!1});if(null!=n){var r=n.responseXML;r&&r.documentElement||(r=n.responseText);var o=new OpenLayers.Format.ArcXML,s=o.read(r);t=this.getUrlOrImage(s.image.output)}return t},getURLasync:function(e,t,i,n){e=this.adjustBounds(e);var r=new OpenLayers.Format.ArcXML(OpenLayers.Util.extend(this.options,{requesttype:"image",envelope:e.toArray(),tileSize:this.tileSize}));OpenLayers.Request.POST({url:this.getFullRequestString(),async:!0,data:r.write(),callback:function(e){var r=e.responseXML;r&&r.documentElement||(r=e.responseText);var o=new OpenLayers.Format.ArcXML,s=o.read(r);t[i]=this.getUrlOrImage(s.image.output),n.apply(t)},scope:this})},getUrlOrImage:function(e){var t="";return e.url?t=e.url:e.data&&(t="data:image/"+e.type+";base64,"+e.data),t},setLayerQuery:function(e,t){for(var i=0;this.options.layers.length>i;i++)if(e==this.options.layers[i].id)return this.options.layers[i].query=t,void 0;this.options.layers.push({id:e,visible:!0,query:t})},getFeatureInfo:function(e,t,i){var n=i.buffer||1,r=i.callback||function(){},o=i.scope||window,s={};OpenLayers.Util.extend(s,this.options),s.requesttype="feature",e instanceof OpenLayers.LonLat?(s.polygon=null,s.envelope=[e.lon-n,e.lat-n,e.lon+n,e.lat+n]):e instanceof OpenLayers.Geometry.Polygon&&(s.envelope=null,s.polygon=e);var a=new OpenLayers.Format.ArcXML(s);if(OpenLayers.Util.extend(a.request.get_feature,i),a.request.get_feature.layer=t.id,"number"==typeof t.query.accuracy)a.request.get_feature.query.accuracy=t.query.accuracy;else{var l=this.map.getCenter(),c=this.map.getViewPortPxFromLonLat(l);c.x++;var u=this.map.getLonLatFromPixel(c);a.request.get_feature.query.accuracy=u.lon-l.lon}a.request.get_feature.query.where=t.query.where,a.request.get_feature.query.spatialfilter.relation="area_intersection",OpenLayers.Request.POST({url:this.getFullRequestString({CustomService:"Query"}),data:a.write(),callback:function(e){var t=a.parseResponse(e.responseText);a.iserror()?r.call(o,null):r.call(o,t.features)}})},clone:function(e){return null==e&&(e=new OpenLayers.Layer.ArcIMS(this.name,this.url,this.getOptions())),e=OpenLayers.Layer.Grid.prototype.clone.apply(this,[e])},CLASS_NAME:"OpenLayers.Layer.ArcIMS"});