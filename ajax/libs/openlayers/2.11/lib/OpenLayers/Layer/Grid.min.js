OpenLayers.Layer.Grid=OpenLayers.Class(OpenLayers.Layer.HTTPRequest,{tileSize:null,tileOriginCorner:"bl",tileOrigin:null,tileOptions:null,grid:null,singleTile:!1,ratio:1.5,buffer:0,numLoadingTiles:0,tileLoadingDelay:100,timerId:null,initialize:function(){OpenLayers.Layer.HTTPRequest.prototype.initialize.apply(this,arguments),this.events.addEventType("tileloaded"),this.grid=[],this._moveGriddedTiles=OpenLayers.Function.bind(this.moveGriddedTiles,this)},removeMap:function(){null!=this.timerId&&(window.clearTimeout(this.timerId),this.timerId=null)},destroy:function(){this.clearGrid(),this.grid=null,this.tileSize=null,OpenLayers.Layer.HTTPRequest.prototype.destroy.apply(this,arguments)},clearGrid:function(){if(this.grid){for(var e=0,t=this.grid.length;t>e;e++)for(var i=this.grid[e],n=0,r=i.length;r>n;n++){var o=i[n];this.removeTileMonitoringHooks(o),o.destroy()}this.grid=[]}},clone:function(e){return null==e&&(e=new OpenLayers.Layer.Grid(this.name,this.url,this.params,this.getOptions())),e=OpenLayers.Layer.HTTPRequest.prototype.clone.apply(this,[e]),null!=this.tileSize&&(e.tileSize=this.tileSize.clone()),e.grid=[],e},moveTo:function(e,t,i){if(OpenLayers.Layer.HTTPRequest.prototype.moveTo.apply(this,arguments),e=e||this.map.getExtent(),null!=e){var n=!this.grid.length||t,r=this.getTilesBounds();this.singleTile?(n||!i&&!r.containsBounds(e))&&this.initSingleTile(e):n||!r.containsBounds(e,!0)?this.initGriddedTiles(e):this.scheduleMoveGriddedTiles()}},moveByPx:function(){this.singleTile||this.scheduleMoveGriddedTiles()},scheduleMoveGriddedTiles:function(){null!=this.timerId&&window.clearTimeout(this.timerId),this.timerId=window.setTimeout(this._moveGriddedTiles,this.tileLoadingDelay)},setTileSize:function(e){this.singleTile&&(e=this.map.getSize(),e.h=parseInt(e.h*this.ratio),e.w=parseInt(e.w*this.ratio)),OpenLayers.Layer.HTTPRequest.prototype.setTileSize.apply(this,[e])},getGridBounds:function(){var e="The getGridBounds() function is deprecated. It will be removed in 3.0. Please use getTilesBounds() instead.";return OpenLayers.Console.warn(e),this.getTilesBounds()},getTilesBounds:function(){var e=null;if(this.grid.length){var t=this.grid.length-1,i=this.grid[t][0],n=this.grid[0].length-1,r=this.grid[0][n];e=new OpenLayers.Bounds(i.bounds.left,i.bounds.bottom,r.bounds.right,r.bounds.top)}return e},initSingleTile:function(e){var t=e.getCenterLonLat(),i=e.getWidth()*this.ratio,n=e.getHeight()*this.ratio,r=new OpenLayers.Bounds(t.lon-i/2,t.lat-n/2,t.lon+i/2,t.lat+n/2),o=new OpenLayers.LonLat(r.left,r.top),s=this.map.getLayerPxFromLonLat(o);this.grid.length||(this.grid[0]=[]);var a=this.grid[0][0];a?a.moveTo(r,s):(a=this.addTile(r,s),this.addTileMonitoringHooks(a),a.draw(),this.grid[0][0]=a),this.removeExcessTiles(1,1)},calculateGridLayout:function(e,t,i){var n=i*this.tileSize.w,r=i*this.tileSize.h,o=e.left-t.lon,s=Math.floor(o/n)-this.buffer,a=o/n-s,l=-a*this.tileSize.w,c=t.lon+s*n,u=e.top-(t.lat+r),h=Math.ceil(u/r)+this.buffer,d=h-u/r,p=-d*this.tileSize.h,f=t.lat+h*r;return{tilelon:n,tilelat:r,tileoffsetlon:c,tileoffsetlat:f,tileoffsetx:l,tileoffsety:p}},getTileOrigin:function(){var e=this.tileOrigin;if(!e){var t=this.getMaxExtent(),i={tl:["left","top"],tr:["right","top"],bl:["left","bottom"],br:["right","bottom"]}[this.tileOriginCorner];e=new OpenLayers.LonLat(t[i[0]],t[i[1]])}return e},initGriddedTiles:function(e){var t=this.map.getSize(),i=Math.ceil(t.h/this.tileSize.h)+Math.max(1,2*this.buffer),n=Math.ceil(t.w/this.tileSize.w)+Math.max(1,2*this.buffer),r=this.getTileOrigin(),o=this.map.getResolution(),s=this.calculateGridLayout(e,r,o),a=Math.round(s.tileoffsetx),l=Math.round(s.tileoffsety),c=s.tileoffsetlon,u=s.tileoffsetlat,h=s.tilelon,d=s.tilelat;this.origin=new OpenLayers.Pixel(a,l);var p=a,f=c,m=0,g=parseInt(this.map.layerContainerDiv.style.left),y=parseInt(this.map.layerContainerDiv.style.top);do{var v=this.grid[m++];v||(v=[],this.grid.push(v)),c=f,a=p;var b=0;do{var x=new OpenLayers.Bounds(c,u,c+h,u+d),C=a;C-=g;var _=l;_-=y;var w=new OpenLayers.Pixel(C,_),S=v[b++];S?S.moveTo(x,w,!1):(S=this.addTile(x,w),this.addTileMonitoringHooks(S),v.push(S)),c+=h,a+=this.tileSize.w}while(e.right+h*this.buffer>=c||n>b);u-=d,l+=this.tileSize.h}while(u>=e.bottom-d*this.buffer||i>m);this.removeExcessTiles(m,b),this.spiralTileLoad()},getMaxExtent:function(){return this.maxExtent},spiralTileLoad:function(){for(var e=[],t=["right","down","left","up"],i=0,n=-1,r=OpenLayers.Util.indexOf(t,"right"),o=0;t.length>o;){var s=i,a=n;switch(t[r]){case"right":a++;break;case"down":s++;break;case"left":a--;break;case"up":s--}var l=null;this.grid.length>s&&s>=0&&this.grid[0].length>a&&a>=0&&(l=this.grid[s][a]),null==l||l.queued?(r=(r+1)%4,o++):(e.unshift(l),l.queued=!0,o=0,i=s,n=a)}for(var c=0,u=e.length;u>c;c++){var l=e[c];l.draw(),l.queued=!1}},addTile:function(e,t){return new OpenLayers.Tile.Image(this,t,e,null,this.tileSize,this.tileOptions)},addTileMonitoringHooks:function(e){e.onLoadStart=function(){0==this.numLoadingTiles&&this.events.triggerEvent("loadstart"),this.numLoadingTiles++},e.events.register("loadstart",this,e.onLoadStart),e.onLoadEnd=function(){this.numLoadingTiles--,this.events.triggerEvent("tileloaded"),0==this.numLoadingTiles&&this.events.triggerEvent("loadend")},e.events.register("loadend",this,e.onLoadEnd),e.events.register("unload",this,e.onLoadEnd)},removeTileMonitoringHooks:function(e){e.unload(),e.events.un({loadstart:e.onLoadStart,loadend:e.onLoadEnd,unload:e.onLoadEnd,scope:this})},moveGriddedTiles:function(){var e=!0,t=this.buffer||1,i=this.grid[0][0].position,n=parseInt(this.map.layerContainerDiv.style.left),r=parseInt(this.map.layerContainerDiv.style.top),o=i.add(n,r);o.x>-this.tileSize.w*(t-1)?this.shiftColumn(!0):o.x<-this.tileSize.w*t?this.shiftColumn(!1):o.y>-this.tileSize.h*(t-1)?this.shiftRow(!0):o.y<-this.tileSize.h*t?this.shiftRow(!1):e=!1,e&&(this.timerId=window.setTimeout(this._moveGriddedTiles,0))},shiftRow:function(e){for(var t=e?0:this.grid.length-1,i=this.grid,n=i[t],r=this.map.getResolution(),o=e?-this.tileSize.h:this.tileSize.h,s=r*-o,a=e?i.pop():i.shift(),l=0,c=n.length;c>l;l++){var u=n[l],h=u.bounds.clone(),d=u.position.clone();h.bottom=h.bottom+s,h.top=h.top+s,d.y=d.y+o,a[l].moveTo(h,d)}e?i.unshift(a):i.push(a)},shiftColumn:function(e){for(var t=e?-this.tileSize.w:this.tileSize.w,i=this.map.getResolution(),n=i*t,r=0,o=this.grid.length;o>r;r++){var s=this.grid[r],a=e?0:s.length-1,l=s[a],c=l.bounds.clone(),u=l.position.clone();c.left=c.left+n,c.right=c.right+n,u.x=u.x+t;var h=e?this.grid[r].pop():this.grid[r].shift();h.moveTo(c,u),e?s.unshift(h):s.push(h)}},removeExcessTiles:function(e,t){for(;this.grid.length>e;)for(var i=this.grid.pop(),n=0,r=i.length;r>n;n++){var o=i[n];this.removeTileMonitoringHooks(o),o.destroy()}for(;this.grid[0].length>t;)for(var n=0,r=this.grid.length;r>n;n++){var i=this.grid[n],o=i.pop();this.removeTileMonitoringHooks(o),o.destroy()}},onMapResize:function(){this.singleTile&&(this.clearGrid(),this.setTileSize())},getTileBounds:function(e){var t=this.maxExtent,i=this.getResolution(),n=i*this.tileSize.w,r=i*this.tileSize.h,o=this.getLonLatFromViewPortPx(e),s=t.left+n*Math.floor((o.lon-t.left)/n),a=t.bottom+r*Math.floor((o.lat-t.bottom)/r);return new OpenLayers.Bounds(s,a,s+n,a+r)},CLASS_NAME:"OpenLayers.Layer.Grid"});