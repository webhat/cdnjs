OpenLayers.Layer.MapGuide=OpenLayers.Class(OpenLayers.Layer.Grid,{isBaseLayer:!0,useHttpTile:!1,singleTile:!1,useOverlay:!1,useAsyncOverlay:!0,TILE_PARAMS:{operation:"GETTILEIMAGE",version:"1.2.0"},SINGLE_TILE_PARAMS:{operation:"GETMAPIMAGE",format:"PNG",locale:"en",clip:"1",version:"1.0.0"},OVERLAY_PARAMS:{operation:"GETDYNAMICMAPOVERLAYIMAGE",format:"PNG",locale:"en",clip:"1",version:"2.0.0"},FOLDER_PARAMS:{tileColumnsPerFolder:30,tileRowsPerFolder:30,format:"png",querystring:null},defaultSize:new OpenLayers.Size(300,300),tileOriginCorner:"tl",initialize:function(e,t,i,n){OpenLayers.Layer.Grid.prototype.initialize.apply(this,arguments),(null==n||null==n.isBaseLayer)&&(this.isBaseLayer="true"!=this.transparent&&1!=this.transparent),n&&null!=n.useOverlay&&(this.useOverlay=n.useOverlay),this.singleTile?this.useOverlay?(OpenLayers.Util.applyDefaults(this.params,this.OVERLAY_PARAMS),this.useAsyncOverlay||(this.params.version="1.0.0")):OpenLayers.Util.applyDefaults(this.params,this.SINGLE_TILE_PARAMS):(this.useHttpTile?OpenLayers.Util.applyDefaults(this.params,this.FOLDER_PARAMS):OpenLayers.Util.applyDefaults(this.params,this.TILE_PARAMS),this.setTileSize(this.defaultSize))},clone:function(e){return null==e&&(e=new OpenLayers.Layer.MapGuide(this.name,this.url,this.params,this.getOptions())),e=OpenLayers.Layer.Grid.prototype.clone.apply(this,[e])},getURL:function(e){var t,i=e.getCenterLonLat(),n=this.map.getSize();if(this.singleTile){var r={setdisplaydpi:OpenLayers.DOTS_PER_INCH,setdisplayheight:n.h*this.ratio,setdisplaywidth:n.w*this.ratio,setviewcenterx:i.lon,setviewcentery:i.lat,setviewscale:this.map.getScale()};if(this.useOverlay&&!this.useAsyncOverlay){var o={};o=OpenLayers.Util.extend(o,r),o.operation="GETVISIBLEMAPEXTENT",o.version="1.0.0",o.session=this.params.session,o.mapName=this.params.mapName,o.format="text/xml",t=this.getFullRequestString(o),OpenLayers.Request.GET({url:t,async:!1})}t=this.getFullRequestString(r)}else{var s=this.map.getResolution(),a=Math.floor((e.left-this.maxExtent.left)/s);a=Math.round(a/this.tileSize.w);var l=Math.floor((this.maxExtent.top-e.top)/s);l=Math.round(l/this.tileSize.h),t=this.useHttpTile?this.getImageFilePath({tilecol:a,tilerow:l,scaleindex:this.resolutions.length-this.map.zoom-1}):this.getFullRequestString({tilecol:a,tilerow:l,scaleindex:this.resolutions.length-this.map.zoom-1})}return t},getFullRequestString:function(e,t){var i=null==t?this.url:t;"object"==typeof i&&(i=i[Math.floor(Math.random()*i.length)]);var n=i,r=OpenLayers.Util.extend({},this.params);r=OpenLayers.Util.extend(r,e);var o=OpenLayers.Util.upperCaseObject(OpenLayers.Util.getParameters(i));for(var s in r)s.toUpperCase()in o&&delete r[s];var a=OpenLayers.Util.getParameterString(r);if(a=a.replace(/,/g,"+"),""!=a){var l=i.charAt(i.length-1);n+="&"==l||"?"==l?a:-1==i.indexOf("?")?"?"+a:"&"+a}return n},getImageFilePath:function(e,t){var i=null==t?this.url:t;"object"==typeof i&&(i=i[Math.floor(Math.random()*i.length)]);var n=i,r="",o="";0>e.tilerow&&(r="-"),r+=0==e.tilerow?"0":Math.floor(Math.abs(e.tilerow/this.params.tileRowsPerFolder))*this.params.tileRowsPerFolder,0>e.tilecol&&(o="-"),o+=0==e.tilecol?"0":Math.floor(Math.abs(e.tilecol/this.params.tileColumnsPerFolder))*this.params.tileColumnsPerFolder;var s="/S"+Math.floor(e.scaleindex)+"/"+this.params.basemaplayergroupname+"/R"+r+"/C"+o+"/"+e.tilerow%this.params.tileRowsPerFolder+"_"+e.tilecol%this.params.tileColumnsPerFolder+"."+this.params.format;return this.params.querystring&&(s+="?"+this.params.querystring),n+=s},calculateGridLayout:function(e,t,i){var n=i*this.tileSize.w,r=i*this.tileSize.h,o=e.left-t.lon,s=Math.floor(o/n)-this.buffer,a=o/n-s,l=-a*this.tileSize.w,c=t.lon+s*n,u=t.lat-e.top+r,h=Math.floor(u/r)-this.buffer,d=h-u/r,p=d*this.tileSize.h,f=t.lat-r*h;return{tilelon:n,tilelat:r,tileoffsetlon:c,tileoffsetlat:f,tileoffsetx:l,tileoffsety:p}},CLASS_NAME:"OpenLayers.Layer.MapGuide"});