OpenLayers.Protocol.SQL.Gears=OpenLayers.Class(OpenLayers.Protocol.SQL,{FID_PREFIX:"__gears_fid__",NULL_GEOMETRY:"__gears_null_geometry__",NULL_FEATURE_STATE:"__gears_null_feature_state__",jsonParser:null,wktParser:null,fidRegExp:null,saveFeatureState:!0,typeOfFid:"string",db:null,initialize:function(e){this.supported()&&(OpenLayers.Protocol.SQL.prototype.initialize.apply(this,[e]),this.jsonParser=new OpenLayers.Format.JSON,this.wktParser=new OpenLayers.Format.WKT,this.fidRegExp=RegExp("^"+this.FID_PREFIX),this.initializeDatabase())},initializeDatabase:function(){this.db=google.gears.factory.create("beta.database"),this.db.open(this.databaseName),this.db.execute("CREATE TABLE IF NOT EXISTS "+this.tableName+" (fid TEXT UNIQUE, geometry TEXT, properties TEXT,"+"  state TEXT)")},destroy:function(){this.db.close(),this.db=null,this.jsonParser=null,this.wktParser=null,OpenLayers.Protocol.SQL.prototype.destroy.apply(this)},supported:function(){return!(!window.google||!google.gears)},read:function(e){OpenLayers.Protocol.prototype.read.apply(this,arguments),e=OpenLayers.Util.applyDefaults(e,this.options);for(var t,i=[],n=this.db.execute("SELECT * FROM "+this.tableName);n.isValidRow();)t=this.unfreezeFeature(n),this.evaluateFilter(t,e.filter)&&(e.noFeatureStateReset||(t.state=null),i.push(t)),n.next();n.close();var r=new OpenLayers.Protocol.Response({code:OpenLayers.Protocol.Response.SUCCESS,requestType:"read",features:i});return e&&e.callback&&e.callback.call(e.scope,r),r},unfreezeFeature:function(e){var t,i=e.fieldByName("geometry");t=i==this.NULL_GEOMETRY?new OpenLayers.Feature.Vector:this.wktParser.read(i),t.attributes=this.jsonParser.read(e.fieldByName("properties")),t.fid=this.extractFidFromField(e.fieldByName("fid"));var n=e.fieldByName("state");return n==this.NULL_FEATURE_STATE&&(n=null),t.state=n,t},extractFidFromField:function(e){return e.match(this.fidRegExp)||"number"!=this.typeOfFid||(e=parseFloat(e)),e},create:function(e,t){t=OpenLayers.Util.applyDefaults(t,this.options);var i=this.createOrUpdate(e);return i.requestType="create",t&&t.callback&&t.callback.call(t.scope,i),i},update:function(e,t){t=OpenLayers.Util.applyDefaults(t,this.options);var i=this.createOrUpdate(e);return i.requestType="update",t&&t.callback&&t.callback.call(t.scope,i),i},createOrUpdate:function(e){OpenLayers.Util.isArray(e)||(e=[e]);var t,i,n=e.length,r=Array(n);for(t=0;n>t;t++){i=e[t];var o=this.freezeFeature(i);this.db.execute("REPLACE INTO "+this.tableName+" (fid, geometry, properties, state)"+" VALUES (?, ?, ?, ?)",o);var s=i.clone();s.fid=this.extractFidFromField(o[0]),r[t]=s}return new OpenLayers.Protocol.Response({code:OpenLayers.Protocol.Response.SUCCESS,features:r,reqFeatures:e})},freezeFeature:function(e){e.fid=null!=e.fid?""+e.fid:OpenLayers.Util.createUniqueID(this.FID_PREFIX);var t=null!=e.geometry?""+e.geometry:this.NULL_GEOMETRY,i=this.jsonParser.write(e.attributes),n=this.getFeatureStateForFreeze(e);return[e.fid,t,i,n]},getFeatureStateForFreeze:function(e){var t;return t=this.saveFeatureState?this.createdOffline(e)?OpenLayers.State.INSERT:e.state:this.NULL_FEATURE_STATE},"delete":function(e,t){OpenLayers.Util.isArray(e)||(e=[e]),t=OpenLayers.Util.applyDefaults(t,this.options);var i,n,r;for(i=0,n=e.length;n>i;i++)if(r=e[i],this.saveFeatureState&&!this.createdOffline(r)){var o=r.clone();o.fid=r.fid,o.geometry&&(o.geometry.destroy(),o.geometry=null),o.state=r.state,this.createOrUpdate(o)}else this.db.execute("DELETE FROM "+this.tableName+" WHERE fid = ?",[r.fid]);var s=new OpenLayers.Protocol.Response({code:OpenLayers.Protocol.Response.SUCCESS,requestType:"delete",reqFeatures:e});return t&&t.callback&&t.callback.call(t.scope,s),s},createdOffline:function(e){return"string"==typeof e.fid&&!!e.fid.match(this.fidRegExp)},commit:function(e,t){function i(e){s>++a&&(e.last=!1),this.callUserCallback(t,e)}for(var n,r,o=[],s=0,a=0,l=[],c=[],h=[],u=e.length-1;u>=0;u--)switch(r=e[u],r.state){case OpenLayers.State.INSERT:l.push(r);break;case OpenLayers.State.UPDATE:c.push(r);break;case OpenLayers.State.DELETE:h.push(r)}return l.length>0&&(s++,n=OpenLayers.Util.applyDefaults({callback:i,scope:this},t.create),o.push(this.create(l,n))),c.length>0&&(s++,n=OpenLayers.Util.applyDefaults({callback:i,scope:this},t.update),o.push(this.update(c,n))),h.length>0&&(s++,n=OpenLayers.Util.applyDefaults({callback:i,scope:this},t["delete"]),o.push(this["delete"](h,n))),o},clear:function(){this.db.execute("DELETE FROM "+this.tableName)},callUserCallback:function(e,t){var i=e[t.requestType];i&&i.callback&&i.callback.call(i.scope,t),t.last&&e.callback&&e.callback.call(e.scope)},CLASS_NAME:"OpenLayers.Protocol.SQL.Gears"});