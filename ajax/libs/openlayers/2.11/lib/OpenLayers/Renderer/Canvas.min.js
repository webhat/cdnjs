OpenLayers.Renderer.Canvas=OpenLayers.Class(OpenLayers.Renderer,{hitDetection:!0,hitOverflow:0,canvas:null,features:null,pendingRedraw:!1,initialize:function(){OpenLayers.Renderer.prototype.initialize.apply(this,arguments),this.root=document.createElement("canvas"),this.container.appendChild(this.root),this.canvas=this.root.getContext("2d"),this.features={},this.hitDetection&&(this.hitCanvas=document.createElement("canvas"),this.hitContext=this.hitCanvas.getContext("2d"))},eraseGeometry:function(e,t){this.eraseFeatures(this.features[t][0])},supported:function(){var e=document.createElement("canvas");return!!e.getContext},setSize:function(e){this.size=e.clone();var t=this.root;if(t.style.width=e.w+"px",t.style.height=e.h+"px",t.width=e.w,t.height=e.h,this.resolution=null,this.hitDetection){var i=this.hitCanvas;i.style.width=e.w+"px",i.style.height=e.h+"px",i.width=e.w,i.height=e.h}},drawFeature:function(e,t){var i;if(e.geometry){t=this.applyDefaultSymbolizer(t||e.style);var n=e.geometry.getBounds();i="none"!==t.display&&!!n&&n.intersectsBounds(this.extent),i?this.features[e.id]=[e,t]:delete this.features[e.id],this.pendingRedraw=!0}return this.pendingRedraw&&!this.locked&&(this.redraw(),this.pendingRedraw=!1),i},drawGeometry:function(e,t,i){var n=e.CLASS_NAME;if("OpenLayers.Geometry.Collection"!=n&&"OpenLayers.Geometry.MultiPoint"!=n&&"OpenLayers.Geometry.MultiLineString"!=n&&"OpenLayers.Geometry.MultiPolygon"!=n)switch(e.CLASS_NAME){case"OpenLayers.Geometry.Point":this.drawPoint(e,t,i);break;case"OpenLayers.Geometry.LineString":this.drawLineString(e,t,i);break;case"OpenLayers.Geometry.LinearRing":this.drawLinearRing(e,t,i);break;case"OpenLayers.Geometry.Polygon":this.drawPolygon(e,t,i);break;default:}else for(var r=0;e.components.length>r;r++)this.drawGeometry(e.components[r],t,i)},drawExternalGraphic:function(e,t,i){var n=new Image;t.graphicTitle&&(n.title=t.graphicTitle);var r=t.graphicWidth||t.graphicHeight,o=t.graphicHeight||t.graphicWidth;r=r?r:2*t.pointRadius,o=o?o:2*t.pointRadius;var s=void 0!=t.graphicXOffset?t.graphicXOffset:-(.5*r),a=void 0!=t.graphicYOffset?t.graphicYOffset:-(.5*o),l=t.graphicOpacity||t.fillOpacity,c=function(){if(this.features[i]){var t=this.getLocalXY(e),c=t[0],h=t[1];if(!isNaN(c)&&!isNaN(h)){var u=0|c+s,d=0|h+a,p=this.canvas;p.globalAlpha=l;var f=OpenLayers.Renderer.Canvas.drawImageScaleFactor||(OpenLayers.Renderer.Canvas.drawImageScaleFactor=/android 2.1/.test(navigator.userAgent.toLowerCase())?320/window.screen.width:1);p.drawImage(n,u*f,d*f,r*f,o*f),this.hitDetection&&(this.setHitContextStyle("fill",i),this.hitContext.fillRect(u,d,r,o))}}};n.onload=OpenLayers.Function.bind(c,this),n.src=t.externalGraphic},setCanvasStyle:function(e,t){"fill"===e?(this.canvas.globalAlpha=t.fillOpacity,this.canvas.fillStyle=t.fillColor):"stroke"===e?(this.canvas.globalAlpha=t.strokeOpacity,this.canvas.strokeStyle=t.strokeColor,this.canvas.lineWidth=t.strokeWidth):(this.canvas.globalAlpha=0,this.canvas.lineWidth=1)},featureIdToHex:function(e){var t=Number(e.split("_").pop())+1;t>=16777216&&(this.hitOverflow=t-16777215,t=t%16777216+1);var i="000000"+t.toString(16),n=i.length;return i="#"+i.substring(n-6,n)},setHitContextStyle:function(e,t,i){var n=this.featureIdToHex(t);"fill"==e?(this.hitContext.globalAlpha=1,this.hitContext.fillStyle=n):"stroke"==e?(this.hitContext.globalAlpha=1,this.hitContext.strokeStyle=n,this.hitContext.lineWidth=i.strokeWidth+2):(this.hitContext.globalAlpha=0,this.hitContext.lineWidth=1)},drawPoint:function(e,t,i){if(t.graphic!==!1)if(t.externalGraphic)this.drawExternalGraphic(e,t,i);else{var n=this.getLocalXY(e),r=n[0],o=n[1];if(!isNaN(r)&&!isNaN(o)){var s=2*Math.PI,a=t.pointRadius;t.fill!==!1&&(this.setCanvasStyle("fill",t),this.canvas.beginPath(),this.canvas.arc(r,o,a,0,s,!0),this.canvas.fill(),this.hitDetection&&(this.setHitContextStyle("fill",i,t),this.hitContext.beginPath(),this.hitContext.arc(r,o,a,0,s,!0),this.hitContext.fill())),t.stroke!==!1&&(this.setCanvasStyle("stroke",t),this.canvas.beginPath(),this.canvas.arc(r,o,a,0,s,!0),this.canvas.stroke(),this.hitDetection&&(this.setHitContextStyle("stroke",i,t),this.hitContext.beginPath(),this.hitContext.arc(r,o,a,0,s,!0),this.hitContext.stroke()),this.setCanvasStyle("reset"))}}},drawLineString:function(e,t,i){t=OpenLayers.Util.applyDefaults({fill:!1},t),this.drawLinearRing(e,t,i)},drawLinearRing:function(e,t,i){t.fill!==!1&&(this.setCanvasStyle("fill",t),this.renderPath(this.canvas,e,t,i,"fill"),this.hitDetection&&(this.setHitContextStyle("fill",i,t),this.renderPath(this.hitContext,e,t,i,"fill"))),t.stroke!==!1&&(this.setCanvasStyle("stroke",t),this.renderPath(this.canvas,e,t,i,"stroke"),this.hitDetection&&(this.setHitContextStyle("stroke",i,t),this.renderPath(this.hitContext,e,t,i,"stroke"))),this.setCanvasStyle("reset")},renderPath:function(e,t,i,n,r){var o=t.components,s=o.length;e.beginPath();var a=this.getLocalXY(o[0]),l=a[0],c=a[1];if(!isNaN(l)&&!isNaN(c)){e.moveTo(a[0],a[1]);for(var h=1;s>h;++h){var u=this.getLocalXY(o[h]);e.lineTo(u[0],u[1])}"fill"===r?e.fill():e.stroke()}},drawPolygon:function(e,t,i){var n=e.components,r=n.length;this.drawLinearRing(n[0],t,i);for(var o=1;r>o;++o)this.canvas.globalCompositeOperation="destination-out",this.hitDetection&&(this.hitContext.globalCompositeOperation="destination-out"),this.drawLinearRing(n[o],OpenLayers.Util.applyDefaults({stroke:!1,fillOpacity:1},t),i),this.canvas.globalCompositeOperation="source-over",this.hitDetection&&(this.hitContext.globalCompositeOperation="source-over"),this.drawLinearRing(n[o],OpenLayers.Util.applyDefaults({fill:!1},t),i)},drawText:function(e,t){t=OpenLayers.Util.extend({fontColor:"#000000",labelAlign:"cm"},t);var i=this.getLocalXY(e);this.setCanvasStyle("reset"),this.canvas.fillStyle=t.fontColor,this.canvas.globalAlpha=t.fontOpacity||1;var n=[t.fontStyle?t.fontStyle:"normal","normal",t.fontWeight?t.fontWeight:"normal",t.fontSize?t.fontSize:"1em",t.fontFamily?t.fontFamily:"sans-serif"].join(" "),r=t.label.split("\n"),o=r.length;if(this.canvas.fillText){this.canvas.font=n,this.canvas.textAlign=OpenLayers.Renderer.Canvas.LABEL_ALIGN[t.labelAlign[0]]||"center",this.canvas.textBaseline=OpenLayers.Renderer.Canvas.LABEL_ALIGN[t.labelAlign[1]]||"middle";var s=OpenLayers.Renderer.Canvas.LABEL_FACTOR[t.labelAlign[1]];null==s&&(s=-.5);var a=this.canvas.measureText("Mg").height||this.canvas.measureText("xx").width;i[1]+=a*s*(o-1);for(var l=0;o>l;l++)this.canvas.fillText(r[l],i[0],i[1]+a*l)}else if(this.canvas.mozDrawText){this.canvas.mozTextStyle=n;var c=OpenLayers.Renderer.Canvas.LABEL_FACTOR[t.labelAlign[0]];null==c&&(c=-.5);var s=OpenLayers.Renderer.Canvas.LABEL_FACTOR[t.labelAlign[1]];null==s&&(s=-.5);var a=this.canvas.mozMeasureText("xx");i[1]+=a*(1+s*o);for(var l=0;o>l;l++){var h=i[0]+c*this.canvas.mozMeasureText(r[l]),u=i[1]+l*a;this.canvas.translate(h,u),this.canvas.mozDrawText(r[l]),this.canvas.translate(-h,-u)}}this.setCanvasStyle("reset")},getLocalXY:function(e){var t=this.getResolution(),i=this.extent,n=e.x/t+-i.left/t,r=i.top/t-e.y/t;return[n,r]},clear:function(){var e=this.root.height,t=this.root.width;this.canvas.clearRect(0,0,t,e),this.features={},this.hitDetection&&this.hitContext.clearRect(0,0,t,e)},getFeatureIdFromEvent:function(e){var t=null;if(this.hitDetection&&!this.map.dragging){var i=e.xy,n=0|i.x,r=0|i.y,o=this.hitContext.getImageData(n,r,1,1).data;if(255===o[3]){var s=o[2]+256*(o[1]+256*o[0]);s&&(t=this.features["OpenLayers.Feature.Vector_"+(s-1+this.hitOverflow)][0])}}return t},eraseFeatures:function(e){OpenLayers.Util.isArray(e)||(e=[e]);for(var t=0;e.length>t;++t)delete this.features[e[t].id];this.redraw()},redraw:function(){if(!this.locked){var e=this.root.height,t=this.root.width;this.canvas.clearRect(0,0,t,e),this.hitDetection&&this.hitContext.clearRect(0,0,t,e);var i,n,r=[];for(var o in this.features)this.features.hasOwnProperty(o)&&(i=this.features[o][0],n=this.features[o][1],this.drawGeometry(i.geometry,n,i.id),n.label&&r.push([i,n]));for(var s,a=0,l=r.length;l>a;++a)s=r[a],this.drawText(s[0].geometry.getCentroid(),s[1])}},CLASS_NAME:"OpenLayers.Renderer.Canvas"}),OpenLayers.Renderer.Canvas.LABEL_ALIGN={l:"left",r:"right",t:"top",b:"bottom"},OpenLayers.Renderer.Canvas.LABEL_FACTOR={l:0,r:-1,t:0,b:-1},OpenLayers.Renderer.Canvas.drawImageScaleFactor=null;