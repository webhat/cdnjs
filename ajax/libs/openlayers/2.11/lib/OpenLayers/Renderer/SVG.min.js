OpenLayers.Renderer.SVG=OpenLayers.Class(OpenLayers.Renderer.Elements,{xmlns:"http://www.w3.org/2000/svg",xlinkns:"http://www.w3.org/1999/xlink",MAX_PIXEL:15e3,translationParameters:null,symbolMetrics:null,initialize:function(){this.supported()&&(OpenLayers.Renderer.Elements.prototype.initialize.apply(this,arguments),this.translationParameters={x:0,y:0},this.symbolMetrics={})},supported:function(){var e="http://www.w3.org/TR/SVG11/feature#";return document.implementation&&(document.implementation.hasFeature("org.w3c.svg","1.0")||document.implementation.hasFeature(e+"SVG","1.1")||document.implementation.hasFeature(e+"BasicStructure","1.1"))},inValidRange:function(e,t,i){var n=e+(i?0:this.translationParameters.x),r=t+(i?0:this.translationParameters.y);return n>=-this.MAX_PIXEL&&this.MAX_PIXEL>=n&&r>=-this.MAX_PIXEL&&this.MAX_PIXEL>=r},setExtent:function(e,t){OpenLayers.Renderer.Elements.prototype.setExtent.apply(this,arguments);var i=this.getResolution(),n=-e.left/i,r=e.top/i;if(t){this.left=n,this.top=r;var o="0 0 "+this.size.w+" "+this.size.h;return this.rendererRoot.setAttributeNS(null,"viewBox",o),this.translate(0,0),!0}var s=this.translate(n-this.left,r-this.top);return s||this.setExtent(e,!0),s},translate:function(e,t){if(this.inValidRange(e,t,!0)){var i="";return(e||t)&&(i="translate("+e+","+t+")"),this.root.setAttributeNS(null,"transform",i),this.translationParameters={x:e,y:t},!0}return!1},setSize:function(){OpenLayers.Renderer.prototype.setSize.apply(this,arguments),this.rendererRoot.setAttributeNS(null,"width",this.size.w),this.rendererRoot.setAttributeNS(null,"height",this.size.h)},getNodeType:function(e,t){var i=null;switch(e.CLASS_NAME){case"OpenLayers.Geometry.Point":i=t.externalGraphic?"image":this.isComplexSymbol(t.graphicName)?"svg":"circle";break;case"OpenLayers.Geometry.Rectangle":i="rect";break;case"OpenLayers.Geometry.LineString":i="polyline";break;case"OpenLayers.Geometry.LinearRing":i="polygon";break;case"OpenLayers.Geometry.Polygon":case"OpenLayers.Geometry.Curve":case"OpenLayers.Geometry.Surface":i="path";break;default:}return i},setStyle:function(e,t,i){t=t||e._style,i=i||e._options;var n,r=parseFloat(e.getAttributeNS(null,"r")),o=1;if("OpenLayers.Geometry.Point"==e._geometryClass&&r){if(e.style.visibility="",t.graphic===!1)e.style.visibility="hidden";else if(t.externalGraphic){if(n=this.getPosition(e),t.graphicTitle){e.setAttributeNS(null,"title",t.graphicTitle);var s=this.nodeFactory(null,"title");s.textContent=t.graphicTitle,e.appendChild(s)}t.graphicWidth&&t.graphicHeight&&e.setAttributeNS(null,"preserveAspectRatio","none");var a=t.graphicWidth||t.graphicHeight,l=t.graphicHeight||t.graphicWidth;a=a?a:2*t.pointRadius,l=l?l:2*t.pointRadius;var c=void 0!=t.graphicXOffset?t.graphicXOffset:-(.5*a),h=void 0!=t.graphicYOffset?t.graphicYOffset:-(.5*l),u=t.graphicOpacity||t.fillOpacity;e.setAttributeNS(null,"x",(n.x+c).toFixed()),e.setAttributeNS(null,"y",(n.y+h).toFixed()),e.setAttributeNS(null,"width",a),e.setAttributeNS(null,"height",l),e.setAttributeNS(this.xlinkns,"href",t.externalGraphic),e.setAttributeNS(null,"style","opacity: "+u),e.onclick=OpenLayers.Renderer.SVG.preventDefault}else if(this.isComplexSymbol(t.graphicName)){var d=3*t.pointRadius,p=2*d,f=this.importSymbol(t.graphicName);n=this.getPosition(e),o=3*this.symbolMetrics[f.id][0]/p;var m=e.parentNode,g=e.nextSibling;m&&m.removeChild(e),e.firstChild&&e.removeChild(e.firstChild),e.appendChild(f.firstChild.cloneNode(!0)),e.setAttributeNS(null,"viewBox",f.getAttributeNS(null,"viewBox")),e.setAttributeNS(null,"width",p),e.setAttributeNS(null,"height",p),e.setAttributeNS(null,"x",n.x-d),e.setAttributeNS(null,"y",n.y-d),g?m.insertBefore(e,g):m&&m.appendChild(e)}else e.setAttributeNS(null,"r",t.pointRadius);var y=t.rotation;if((void 0!==y||void 0!==e._rotation)&&n)if(e._rotation=y,y|=0,"svg"!==e.nodeName)e.setAttributeNS(null,"transform","rotate("+y+" "+n.x+" "+n.y+")");else{var v=this.symbolMetrics[f.id];e.firstChild.setAttributeNS(null,"transform","rotate("+y+" "+v[1]+" "+v[2]+")")}}return i.isFilled?(e.setAttributeNS(null,"fill",t.fillColor),e.setAttributeNS(null,"fill-opacity",t.fillOpacity)):e.setAttributeNS(null,"fill","none"),i.isStroked?(e.setAttributeNS(null,"stroke",t.strokeColor),e.setAttributeNS(null,"stroke-opacity",t.strokeOpacity),e.setAttributeNS(null,"stroke-width",t.strokeWidth*o),e.setAttributeNS(null,"stroke-linecap",t.strokeLinecap||"round"),e.setAttributeNS(null,"stroke-linejoin","round"),t.strokeDashstyle&&e.setAttributeNS(null,"stroke-dasharray",this.dashStyle(t,o))):e.setAttributeNS(null,"stroke","none"),t.pointerEvents&&e.setAttributeNS(null,"pointer-events",t.pointerEvents),null!=t.cursor&&e.setAttributeNS(null,"cursor",t.cursor),e},dashStyle:function(e,t){var i=e.strokeWidth*t,n=e.strokeDashstyle;switch(n){case"solid":return"none";case"dot":return[1,4*i].join();case"dash":return[4*i,4*i].join();case"dashdot":return[4*i,4*i,1,4*i].join();case"longdash":return[8*i,4*i].join();case"longdashdot":return[8*i,4*i,1,4*i].join();default:return OpenLayers.String.trim(n).replace(/\s+/g,",")}},createNode:function(e,t){var i=document.createElementNS(this.xmlns,e);return t&&i.setAttributeNS(null,"id",t),i},nodeTypeCompare:function(e,t){return t==e.nodeName},createRenderRoot:function(){return this.nodeFactory(this.container.id+"_svgRoot","svg")},createRoot:function(e){return this.nodeFactory(this.container.id+e,"g")},createDefs:function(){var e=this.nodeFactory(this.container.id+"_defs","defs");return this.rendererRoot.appendChild(e),e},drawPoint:function(e,t){return this.drawCircle(e,t,1)},drawCircle:function(e,t,i){var n=this.getResolution(),r=t.x/n+this.left,o=this.top-t.y/n;return this.inValidRange(r,o)?(e.setAttributeNS(null,"cx",r),e.setAttributeNS(null,"cy",o),e.setAttributeNS(null,"r",i),e):!1},drawLineString:function(e,t){var i=this.getComponentsString(t.components);return i.path?(e.setAttributeNS(null,"points",i.path),i.complete?e:null):!1},drawLinearRing:function(e,t){var i=this.getComponentsString(t.components);return i.path?(e.setAttributeNS(null,"points",i.path),i.complete?e:null):!1},drawPolygon:function(e,t){for(var i,n,r="",o=!0,s=!0,a=0,l=t.components.length;l>a;a++)r+=" M",i=this.getComponentsString(t.components[a].components," "),n=i.path,n?(r+=" "+n,s=i.complete&&s):o=!1;return r+=" z",o?(e.setAttributeNS(null,"d",r),e.setAttributeNS(null,"fill-rule","evenodd"),s?e:null):!1},drawRectangle:function(e,t){var i=this.getResolution(),n=t.x/i+this.left,r=this.top-t.y/i;return this.inValidRange(n,r)?(e.setAttributeNS(null,"x",n),e.setAttributeNS(null,"y",r),e.setAttributeNS(null,"width",t.width/i),e.setAttributeNS(null,"height",t.height/i),e):!1},drawSurface:function(e,t){for(var i=null,n=!0,r=0,o=t.components.length;o>r;r++)if(0==r%3&&0==r/3){var s=this.getShortString(t.components[r]);s||(n=!1),i="M "+s}else if(1==r%3){var s=this.getShortString(t.components[r]);s||(n=!1),i+=" C "+s}else{var s=this.getShortString(t.components[r]);s||(n=!1),i+=" "+s}return i+=" Z",n?(e.setAttributeNS(null,"d",i),e):!1},drawText:function(e,t,i){var n=this.getResolution(),r=i.x/n+this.left,o=i.y/n-this.top,s=this.nodeFactory(e+this.LABEL_ID_SUFFIX,"text");s.setAttributeNS(null,"x",r),s.setAttributeNS(null,"y",-o),t.fontColor&&s.setAttributeNS(null,"fill",t.fontColor),t.fontOpacity&&s.setAttributeNS(null,"opacity",t.fontOpacity),t.fontFamily&&s.setAttributeNS(null,"font-family",t.fontFamily),t.fontSize&&s.setAttributeNS(null,"font-size",t.fontSize),t.fontWeight&&s.setAttributeNS(null,"font-weight",t.fontWeight),t.fontStyle&&s.setAttributeNS(null,"font-style",t.fontStyle),t.labelSelect===!0?(s.setAttributeNS(null,"pointer-events","visible"),s._featureId=e):s.setAttributeNS(null,"pointer-events","none");var a=t.labelAlign||"cm";s.setAttributeNS(null,"text-anchor",OpenLayers.Renderer.SVG.LABEL_ALIGN[a[0]]||"middle"),OpenLayers.IS_GECKO===!0&&s.setAttributeNS(null,"dominant-baseline",OpenLayers.Renderer.SVG.LABEL_ALIGN[a[1]]||"central");for(var l=t.label.split("\n"),c=l.length;s.childNodes.length>c;)s.removeChild(s.lastChild);for(var h=0;c>h;h++){var u=this.nodeFactory(e+this.LABEL_ID_SUFFIX+"_tspan_"+h,"tspan");if(t.labelSelect===!0&&(u._featureId=e,u._geometry=i,u._geometryClass=i.CLASS_NAME),OpenLayers.IS_GECKO===!1&&u.setAttributeNS(null,"baseline-shift",OpenLayers.Renderer.SVG.LABEL_VSHIFT[a[1]]||"-35%"),u.setAttribute("x",r),0==h){var d=OpenLayers.Renderer.SVG.LABEL_VFACTOR[a[1]];null==d&&(d=-.5),u.setAttribute("dy",d*(c-1)+"em")}else u.setAttribute("dy","1em");u.textContent=""===l[h]?" ":l[h],u.parentNode||s.appendChild(u)}s.parentNode||this.textRoot.appendChild(s)},getComponentsString:function(e,t){for(var i,n,r=[],o=!0,s=e.length,a=[],l=0;s>l;l++)n=e[l],r.push(n),i=this.getShortString(n),i?a.push(i):(l>0&&this.getShortString(e[l-1])&&a.push(this.clipLine(e[l],e[l-1])),s-1>l&&this.getShortString(e[l+1])&&a.push(this.clipLine(e[l],e[l+1])),o=!1);return{path:a.join(t||","),complete:o}},clipLine:function(e,t){if(t.equals(e))return"";var i,n=this.getResolution(),r=this.MAX_PIXEL-this.translationParameters.x,o=this.MAX_PIXEL-this.translationParameters.y,s=t.x/n+this.left,a=this.top-t.y/n,l=e.x/n+this.left,c=this.top-e.y/n;return(-r>l||l>r)&&(i=(c-a)/(l-s),l=0>l?-r:r,c=a+(l-s)*i),(-o>c||c>o)&&(i=(l-s)/(c-a),c=0>c?-o:o,l=s+(c-a)*i),l+","+c},getShortString:function(e){var t=this.getResolution(),i=e.x/t+this.left,n=this.top-e.y/t;return this.inValidRange(i,n)?i+","+n:!1},getPosition:function(e){return{x:parseFloat(e.getAttributeNS(null,"cx")),y:parseFloat(e.getAttributeNS(null,"cy"))}},importSymbol:function(e){this.defs||(this.defs=this.createDefs());var t=this.container.id+"-"+e,i=document.getElementById(t);if(null!=i)return i;var n=OpenLayers.Renderer.symbol[e];if(!n)throw Error(e+" is not a valid symbol name");var r=this.nodeFactory(t,"symbol"),o=this.nodeFactory(null,"polygon");r.appendChild(o);for(var s,a,l=new OpenLayers.Bounds(Number.MAX_VALUE,Number.MAX_VALUE,0,0),c=[],h=0;n.length>h;h+=2)s=n[h],a=n[h+1],l.left=Math.min(l.left,s),l.bottom=Math.min(l.bottom,a),l.right=Math.max(l.right,s),l.top=Math.max(l.top,a),c.push(s,",",a);o.setAttributeNS(null,"points",c.join(" "));var u=l.getWidth(),d=l.getHeight(),p=[l.left-u,l.bottom-d,3*u,3*d];return r.setAttributeNS(null,"viewBox",p.join(" ")),this.symbolMetrics[t]=[Math.max(u,d),l.getCenterLonLat().lon,l.getCenterLonLat().lat],this.defs.appendChild(r),r},getFeatureIdFromEvent:function(e){var t=OpenLayers.Renderer.Elements.prototype.getFeatureIdFromEvent.apply(this,arguments);if(!t){var i=e.target;t=i.parentNode&&i!=this.rendererRoot&&i.parentNode._featureId}return t},CLASS_NAME:"OpenLayers.Renderer.SVG"}),OpenLayers.Renderer.SVG.LABEL_ALIGN={l:"start",r:"end",b:"bottom",t:"hanging"},OpenLayers.Renderer.SVG.LABEL_VSHIFT={t:"-70%",b:"0"},OpenLayers.Renderer.SVG.LABEL_VFACTOR={t:0,b:-1},OpenLayers.Renderer.SVG.preventDefault=function(e){e.preventDefault&&e.preventDefault()};