OpenLayers.Renderer.SVG2=OpenLayers.Class(OpenLayers.Renderer.NG,{xmlns:"http://www.w3.org/2000/svg",xlinkns:"http://www.w3.org/1999/xlink",symbolMetrics:null,labelNodeType:"g",initialize:function(){this.supported()&&(OpenLayers.Renderer.Elements.prototype.initialize.apply(this,arguments),this.symbolMetrics={})},supported:function(){var e="http://www.w3.org/TR/SVG11/feature#";return document.implementation&&(document.implementation.hasFeature("org.w3c.svg","1.0")||document.implementation.hasFeature(e+"SVG","1.1")||document.implementation.hasFeature(e+"BasicStructure","1.1"))},updateDimensions:function(e){OpenLayers.Renderer.NG.prototype.updateDimensions.apply(this,arguments);var t=this.getResolution(),i=this.extent.getWidth(),n=this.extent.getHeight(),r=[this.extent.left,-this.extent.top,i,n].join(" ");if(this.rendererRoot.setAttributeNS(null,"viewBox",r),this.rendererRoot.setAttributeNS(null,"width",i/t),this.rendererRoot.setAttributeNS(null,"height",n/t),e===!0){var o,s,a=this.vectorRoot.childNodes;for(o=0,s=a.length;s>o;++o)this.setStyle(a[o]);var l,c=this.textRoot.childNodes;for(o=0,s=c.length;s>o;++o)l=c[o],this.drawText(l,l._style,new OpenLayers.Geometry.Point(l._x,l._y))}},getNodeType:function(e,t){var i=null;switch(e.CLASS_NAME){case"OpenLayers.Geometry.Point":i=t.externalGraphic?"image":this.isComplexSymbol(t.graphicName)?"svg":"circle";break;case"OpenLayers.Geometry.Rectangle":i="rect";break;case"OpenLayers.Geometry.LineString":i="polyline";break;case"OpenLayers.Geometry.LinearRing":i="polygon";break;case"OpenLayers.Geometry.Polygon":case"OpenLayers.Geometry.Curve":case"OpenLayers.Geometry.Surface":i="path";break;default:}return i},setStyle:function(e,t,i){t=t||e._style,i=i||e._options;var n=this.getResolution(),r=e._radius,o=n;if("OpenLayers.Geometry.Point"==e._geometryClass&&r){if(e.style.visibility="",t.graphic===!1)e.style.visibility="hidden";else if(t.externalGraphic){if(t.graphicTitle){e.setAttributeNS(null,"title",t.graphicTitle);var s=this.nodeFactory(null,"title");s.textContent=t.graphicTitle,e.appendChild(s)}t.graphicWidth&&t.graphicHeight&&e.setAttributeNS(null,"preserveAspectRatio","none");var a=t.graphicWidth||t.graphicHeight,l=t.graphicHeight||t.graphicWidth;a=a?a:2*t.pointRadius,l=l?l:2*t.pointRadius,a*=n,l*=n;var c=void 0!=t.graphicXOffset?t.graphicXOffset*n:-(.5*a),h=void 0!=t.graphicYOffset?t.graphicYOffset*n:-(.5*l),u=t.graphicOpacity||t.fillOpacity;e.setAttributeNS(null,"x",e._x+c),e.setAttributeNS(null,"y",e._y+h),e.setAttributeNS(null,"width",a),e.setAttributeNS(null,"height",l),e.setAttributeNS(this.xlinkns,"href",t.externalGraphic),e.setAttributeNS(null,"style","opacity: "+u),e.onclick=OpenLayers.Renderer.SVG2.preventDefault}else if(this.isComplexSymbol(t.graphicName)){var d=3*t.pointRadius*n,p=2*d,f=this.importSymbol(t.graphicName);o=3*this.symbolMetrics[f.id].size/p*n;var m=e.parentNode,g=e.nextSibling;m&&m.removeChild(e),e.firstChild&&e.removeChild(e.firstChild),e.appendChild(f.firstChild.cloneNode(!0)),e.setAttributeNS(null,"viewBox",f.getAttributeNS(null,"viewBox")),e.setAttributeNS(null,"width",p),e.setAttributeNS(null,"height",p),e.setAttributeNS(null,"x",e._x-d),e.setAttributeNS(null,"y",e._y-d),g?m.insertBefore(e,g):m&&m.appendChild(e)}else e.setAttributeNS(null,"r",t.pointRadius*n);var y=t.rotation;if(void 0!==y||void 0!==e._rotation)if(e._rotation=y,y|=0,"svg"!==e.nodeName)e.setAttributeNS(null,"transform",["rotate(",y,e._x,e._y,")"].join(" "));else{var v=this.symbolMetrics[f.id];e.firstChild.setAttributeNS(null,"transform",["rotate(",y,v.x,v.y,")"].join(" "))}}return i.isFilled?(e.setAttributeNS(null,"fill",t.fillColor),e.setAttributeNS(null,"fill-opacity",t.fillOpacity)):e.setAttributeNS(null,"fill","none"),i.isStroked?(e.setAttributeNS(null,"stroke",t.strokeColor),e.setAttributeNS(null,"stroke-opacity",t.strokeOpacity),e.setAttributeNS(null,"stroke-width",t.strokeWidth*o),e.setAttributeNS(null,"stroke-linecap",t.strokeLinecap||"round"),e.setAttributeNS(null,"stroke-linejoin","round"),t.strokeDashstyle&&e.setAttributeNS(null,"stroke-dasharray",this.dashStyle(t,o))):e.setAttributeNS(null,"stroke","none"),t.pointerEvents&&e.setAttributeNS(null,"pointer-events",t.pointerEvents),null!=t.cursor&&e.setAttributeNS(null,"cursor",t.cursor),e},dashStyle:function(e,t){var i=e.strokeWidth*t,n=e.strokeDashstyle;switch(n){case"solid":return"none";case"dot":return[t,4*i].join();case"dash":return[4*i,4*i].join();case"dashdot":return[4*i,4*i,t,4*i].join();case"longdash":return[8*i,4*i].join();case"longdashdot":return[8*i,4*i,t,4*i].join();default:for(var r=OpenLayers.String.trim(n).split(/\s+/g),o=0,s=r.length;s>o;o++)r[o]=r[o]*t;return r.join()}},createNode:function(e,t){var i=document.createElementNS(this.xmlns,e);return t&&i.setAttributeNS(null,"id",t),i},nodeTypeCompare:function(e,t){return t==e.nodeName},createRenderRoot:function(){return this.nodeFactory(this.container.id+"_svgRoot","svg")},createRoot:function(e){return this.nodeFactory(this.container.id+e,"g")},createDefs:function(){var e=this.nodeFactory(this.container.id+"_defs","defs");return this.rendererRoot.appendChild(e),e},drawPoint:function(e,t){return this.drawCircle(e,t,1)},drawCircle:function(e,t,i){var n=t.x,r=-t.y;return e.setAttributeNS(null,"cx",n),e.setAttributeNS(null,"cy",r),e._x=n,e._y=r,e._radius=i,e},drawLineString:function(e,t){var i=this.getComponentsString(t.components);return e.setAttributeNS(null,"points",i),e},drawLinearRing:function(e,t){var i=this.getComponentsString(t.components);return e.setAttributeNS(null,"points",i),e},drawPolygon:function(e,t){for(var i,n=[],r=0,o=t.components.length;o>r;r++)n.push("M"),i=this.getComponentsString(t.components[r].components," "),n.push(i);return n.push("z"),e.setAttributeNS(null,"d",n.join(" ")),e.setAttributeNS(null,"fill-rule","evenodd"),e},drawRectangle:function(e,t){return e.setAttributeNS(null,"x",t.x),e.setAttributeNS(null,"y",-t.y),e.setAttributeNS(null,"width",t.width),e.setAttributeNS(null,"height",t.height),e},drawSurface:function(e,t){for(var i=[],n=0,r=t.components.length;r>n;n++)if(0==n%3&&0==n/3){var o=this.getShortString(t.components[n]);i.push("M",o)}else if(1==n%3){var o=this.getShortString(t.components[n]);i.push("C",o)}else{var o=this.getShortString(t.components[n]);i.push(o)}return i.push("Z"),e.setAttributeNS(null,"d",i.join(" ")),e},drawText:function(e,t,i){var n=OpenLayers.Renderer.NG.prototype.drawText.apply(this,arguments),r=n.firstChild||this.nodeFactory(e+this.LABEL_ID_SUFFIX+"_text","text"),o=this.getResolution();r.setAttributeNS(null,"x",i.x/o),r.setAttributeNS(null,"y",-i.y/o),n.setAttributeNS(null,"transform","scale("+o+")"),t.fontColor&&r.setAttributeNS(null,"fill",t.fontColor),t.fontOpacity&&r.setAttributeNS(null,"opacity",t.fontOpacity),t.fontFamily&&r.setAttributeNS(null,"font-family",t.fontFamily),t.fontSize&&r.setAttributeNS(null,"font-size",t.fontSize),t.fontWeight&&r.setAttributeNS(null,"font-weight",t.fontWeight),t.fontStyle&&r.setAttributeNS(null,"font-style",t.fontStyle),t.labelSelect===!0?(r.setAttributeNS(null,"pointer-events","visible"),r._featureId=e):r.setAttributeNS(null,"pointer-events","none");var s=t.labelAlign||"cm";r.setAttributeNS(null,"text-anchor",OpenLayers.Renderer.SVG2.LABEL_ALIGN[s[0]]||"middle"),OpenLayers.IS_GECKO===!0&&r.setAttributeNS(null,"dominant-baseline",OpenLayers.Renderer.SVG2.LABEL_ALIGN[s[1]]||"central");for(var a=t.label.split("\n"),l=a.length;r.childNodes.length>l;)r.removeChild(r.lastChild);for(var c=0;l>c;c++){var h=r.childNodes[c]||this.nodeFactory(e+this.LABEL_ID_SUFFIX+"_tspan_"+c,"tspan");if(t.labelSelect===!0&&(h._featureId=e),OpenLayers.IS_GECKO===!1&&h.setAttributeNS(null,"baseline-shift",OpenLayers.Renderer.SVG2.LABEL_VSHIFT[s[1]]||"-35%"),h.setAttribute("x",i.x/o),0==c){var u=OpenLayers.Renderer.SVG2.LABEL_VFACTOR[s[1]];null==u&&(u=-.5),h.setAttribute("dy",u*(l-1)+"em")}else h.setAttribute("dy","1em");h.textContent=""===a[c]?" ":a[c],h.parentNode||r.appendChild(h)}return r.parentNode||n.appendChild(r),n},getComponentsString:function(e,t){for(var i=e.length,n=Array(i),r=0;i>r;r++)n[r]=this.getShortString(e[r]);return n.join(t||",")},getShortString:function(e){return e.x+","+-e.y},importSymbol:function(e){this.defs||(this.defs=this.createDefs());var t=this.container.id+"-"+e,i=document.getElementById(t);if(null!=i)return i;var n=OpenLayers.Renderer.symbol[e];if(!n)throw Error(e+" is not a valid symbol name");var r=this.nodeFactory(t,"symbol"),o=this.nodeFactory(null,"polygon");r.appendChild(o);for(var s,a,l=new OpenLayers.Bounds(Number.MAX_VALUE,Number.MAX_VALUE,0,0),c=[],h=0,u=n.length;u>h;h+=2)s=n[h],a=n[h+1],l.left=Math.min(l.left,s),l.bottom=Math.min(l.bottom,a),l.right=Math.max(l.right,s),l.top=Math.max(l.top,a),c.push(s,",",a);o.setAttributeNS(null,"points",c.join(" "));var d=l.getWidth(),p=l.getHeight(),f=[l.left-d,l.bottom-p,3*d,3*p];return r.setAttributeNS(null,"viewBox",f.join(" ")),this.symbolMetrics[t]={size:Math.max(d,p),x:l.getCenterLonLat().lon,y:l.getCenterLonLat().lat},this.defs.appendChild(r),r},getFeatureIdFromEvent:function(e){var t=OpenLayers.Renderer.Elements.prototype.getFeatureIdFromEvent.apply(this,arguments);if(!t){var i=e.target;t=i.parentNode&&i!=this.rendererRoot&&i.parentNode._featureId}return t},CLASS_NAME:"OpenLayers.Renderer.SVG2"}),OpenLayers.Renderer.SVG2.LABEL_ALIGN={l:"start",r:"end",b:"bottom",t:"hanging"},OpenLayers.Renderer.SVG2.LABEL_VSHIFT={t:"-70%",b:"0"},OpenLayers.Renderer.SVG2.LABEL_VFACTOR={t:0,b:-1},OpenLayers.Renderer.SVG2.preventDefault=function(e){e.preventDefault&&e.preventDefault()};