OpenLayers.Renderer.VML=OpenLayers.Class(OpenLayers.Renderer.Elements,{xmlns:"urn:schemas-microsoft-com:vml",symbolCache:{},offset:null,initialize:function(){if(this.supported()){if(!document.namespaces.olv){document.namespaces.add("olv",this.xmlns);for(var e=document.createStyleSheet(),t=["shape","rect","oval","fill","stroke","imagedata","group","textbox"],i=0,n=t.length;n>i;i++)e.addRule("olv\\:"+t[i],"behavior: url(#default#VML); position: absolute; display: inline-block;")}OpenLayers.Renderer.Elements.prototype.initialize.apply(this,arguments)}},supported:function(){return!!document.namespaces},setExtent:function(e,t){OpenLayers.Renderer.Elements.prototype.setExtent.apply(this,arguments);var i=this.getResolution(),n=0|e.left/i,r=0|e.top/i-this.size.h;t||!this.offset?(this.offset={x:n,y:r},n=0,r=0):(n-=this.offset.x,r-=this.offset.y);var o=n+" "+r;this.root.coordorigin=o;for(var s,a=[this.root,this.vectorRoot,this.textRoot],l=0,c=a.length;c>l;++l){s=a[l];var h=this.size.w+" "+this.size.h;s.coordsize=h}return this.root.style.flip="y",!0},setSize:function(){OpenLayers.Renderer.prototype.setSize.apply(this,arguments);for(var e,t=[this.rendererRoot,this.root,this.vectorRoot,this.textRoot],i=this.size.w+"px",n=this.size.h+"px",r=0,o=t.length;o>r;++r)e=t[r],e.style.width=i,e.style.height=n},getNodeType:function(e,t){var i=null;switch(e.CLASS_NAME){case"OpenLayers.Geometry.Point":i=t.externalGraphic?"olv:rect":this.isComplexSymbol(t.graphicName)?"olv:shape":"olv:oval";break;case"OpenLayers.Geometry.Rectangle":i="olv:rect";break;case"OpenLayers.Geometry.LineString":case"OpenLayers.Geometry.LinearRing":case"OpenLayers.Geometry.Polygon":case"OpenLayers.Geometry.Curve":case"OpenLayers.Geometry.Surface":i="olv:shape";break;default:}return i},setStyle:function(e,t,i,n){t=t||e._style,i=i||e._options;var r=t.fillColor;if("OpenLayers.Geometry.Point"===e._geometryClass)if(t.externalGraphic){i.isFilled=!0,t.graphicTitle&&(e.title=t.graphicTitle);var o=t.graphicWidth||t.graphicHeight,s=t.graphicHeight||t.graphicWidth;o=o?o:2*t.pointRadius,s=s?s:2*t.pointRadius;var a=this.getResolution(),l=void 0!=t.graphicXOffset?t.graphicXOffset:-(.5*o),c=void 0!=t.graphicYOffset?t.graphicYOffset:-(.5*s);e.style.left=(0|n.x/a-this.offset.x+l)+"px",e.style.top=(0|n.y/a-this.offset.y-(c+s))+"px",e.style.width=o+"px",e.style.height=s+"px",e.style.flip="y",r="none",i.isStroked=!1}else if(this.isComplexSymbol(t.graphicName)){var h=this.importSymbol(t.graphicName);e.path=h.path,e.coordorigin=h.left+","+h.bottom;var u=h.size;e.coordsize=u+","+u,this.drawCircle(e,n,t.pointRadius),e.style.flip="y"}else this.drawCircle(e,n,t.pointRadius);i.isFilled?e.fillcolor=r:e.filled="false";var d=e.getElementsByTagName("fill"),p=0==d.length?null:d[0];i.isFilled?(p||(p=this.createNode("olv:fill",e.id+"_fill")),p.opacity=t.fillOpacity,"OpenLayers.Geometry.Point"===e._geometryClass&&t.externalGraphic&&(t.graphicOpacity&&(p.opacity=t.graphicOpacity),p.src=t.externalGraphic,p.type="frame",t.graphicWidth&&t.graphicHeight||(p.aspect="atmost")),p.parentNode!=e&&e.appendChild(p)):p&&e.removeChild(p);var f=t.rotation;(void 0!==f||void 0!==e._rotation)&&(e._rotation=f,t.externalGraphic?(this.graphicRotate(e,l,c,t),p.opacity=0):"OpenLayers.Geometry.Point"===e._geometryClass&&(e.style.rotation=f||0));var m=e.getElementsByTagName("stroke"),g=0==m.length?null:m[0];return i.isStroked?(g||(g=this.createNode("olv:stroke",e.id+"_stroke"),e.appendChild(g)),g.on=!0,g.color=t.strokeColor,g.weight=t.strokeWidth+"px",g.opacity=t.strokeOpacity,g.endcap="butt"==t.strokeLinecap?"flat":t.strokeLinecap||"round",t.strokeDashstyle&&(g.dashstyle=this.dashStyle(t))):(e.stroked=!1,g&&(g.on=!1)),"inherit"!=t.cursor&&null!=t.cursor&&(e.style.cursor=t.cursor),e},graphicRotate:function(e,t,i,n){var r,o,n=n||e._style,s=n.rotation||0;if(!n.graphicWidth||!n.graphicHeight){var a=new Image;return a.onreadystatechange=OpenLayers.Function.bind(function(){("complete"==a.readyState||"interactive"==a.readyState)&&(r=a.width/a.height,o=Math.max(2*n.pointRadius,n.graphicWidth||0,n.graphicHeight||0),t*=r,n.graphicWidth=o*r,n.graphicHeight=o,this.graphicRotate(e,t,i,n))},this),a.src=n.externalGraphic,void 0}o=Math.max(n.graphicWidth,n.graphicHeight),r=n.graphicWidth/n.graphicHeight;var l=Math.round(n.graphicWidth||o*r),c=Math.round(n.graphicHeight||o);e.style.width=l+"px",e.style.height=c+"px";var h=document.getElementById(e.id+"_image");h||(h=this.createNode("olv:imagedata",e.id+"_image"),e.appendChild(h)),h.style.width=l+"px",h.style.height=c+"px",h.src=n.externalGraphic,h.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='', sizingMethod='scale')";var u=s*Math.PI/180,d=Math.sin(u),p=Math.cos(u),f="progid:DXImageTransform.Microsoft.Matrix(M11="+p+",M12="+-d+",M21="+d+",M22="+p+",SizingMethod='auto expand')\n",m=n.graphicOpacity||n.fillOpacity;m&&1!=m&&(f+="progid:DXImageTransform.Microsoft.BasicImage(opacity="+m+")\n"),e.style.filter=f;var g=new OpenLayers.Geometry.Point(-t,-i),y=new OpenLayers.Bounds(0,0,l,c).toGeometry();y.rotate(n.rotation,g);var v=y.getBounds();e.style.left=Math.round(parseInt(e.style.left)+v.left)+"px",e.style.top=Math.round(parseInt(e.style.top)-v.bottom)+"px"},postDraw:function(e){e.style.visibility="visible";var t=e._style.fillColor,i=e._style.strokeColor;"none"==t&&e.fillcolor!=t&&(e.fillcolor=t),"none"==i&&e.strokecolor!=i&&(e.strokecolor=i)},setNodeDimension:function(e,t){var i=t.getBounds();if(i){var n=this.getResolution(),r=new OpenLayers.Bounds(0|i.left/n-this.offset.x,0|i.bottom/n-this.offset.y,0|i.right/n-this.offset.x,0|i.top/n-this.offset.y);e.style.left=r.left+"px",e.style.top=r.top+"px",e.style.width=r.getWidth()+"px",e.style.height=r.getHeight()+"px",e.coordorigin=r.left+" "+r.top,e.coordsize=r.getWidth()+" "+r.getHeight()}},dashStyle:function(e){var t=e.strokeDashstyle;switch(t){case"solid":case"dot":case"dash":case"dashdot":case"longdash":case"longdashdot":return t;default:var i=t.split(/[ ,]/);return 2==i.length?1*i[0]>=2*i[1]?"longdash":1==i[0]||1==i[1]?"dot":"dash":4==i.length?1*i[0]>=2*i[1]?"longdashdot":"dashdot":"solid"}},createNode:function(e,t){var i=document.createElement(e);return t&&(i.id=t),i.unselectable="on",i.onselectstart=OpenLayers.Function.False,i},nodeTypeCompare:function(e,t){var i=t,n=i.indexOf(":");-1!=n&&(i=i.substr(n+1));var r=e.nodeName;return n=r.indexOf(":"),-1!=n&&(r=r.substr(n+1)),i==r},createRenderRoot:function(){return this.nodeFactory(this.container.id+"_vmlRoot","div")},createRoot:function(e){return this.nodeFactory(this.container.id+e,"olv:group")},drawPoint:function(e,t){return this.drawCircle(e,t,1)},drawCircle:function(e,t,i){if(!isNaN(t.x)&&!isNaN(t.y)){var n=this.getResolution();e.style.left=(0|t.x/n-this.offset.x)-i+"px",e.style.top=(0|t.y/n-this.offset.y)-i+"px";var r=2*i;return e.style.width=r+"px",e.style.height=r+"px",e}return!1},drawLineString:function(e,t){return this.drawLine(e,t,!1)},drawLinearRing:function(e,t){return this.drawLine(e,t,!0)},drawLine:function(e,t,i){this.setNodeDimension(e,t);for(var n,r,o,s=this.getResolution(),a=t.components.length,l=Array(a),c=0;a>c;c++)n=t.components[c],r=0|n.x/s-this.offset.x,o=0|n.y/s-this.offset.y,l[c]=" "+r+","+o+" l ";var h=i?" x e":" e";return e.path="m"+l.join("")+h,e},drawPolygon:function(e,t){this.setNodeDimension(e,t);var i,n,r,o,s,a,l,c,h,u,d,p,f=this.getResolution(),m=[];for(i=0,n=t.components.length;n>i;i++){for(m.push("m"),r=t.components[i].components,o=0===i,s=null,a=null,l=0,c=r.length;c>l;l++)h=r[l],d=0|h.x/f-this.offset.x,p=0|h.y/f-this.offset.y,u=" "+d+","+p,m.push(u),0==l&&m.push(" l"),o||(s?s!=u&&(a?a!=u&&(o=!0):a=u):s=u);m.push(o?" x ":" ")}return m.push("e"),e.path=m.join(""),e},drawRectangle:function(e,t){var i=this.getResolution();return e.style.left=(0|t.x/i-this.offset.x)+"px",e.style.top=(0|t.y/i-this.offset.y)+"px",e.style.width=(0|t.width/i)+"px",e.style.height=(0|t.height/i)+"px",e},drawText:function(e,t,i){var n=this.nodeFactory(e+this.LABEL_ID_SUFFIX,"olv:rect"),r=this.nodeFactory(e+this.LABEL_ID_SUFFIX+"_textbox","olv:textbox"),o=this.getResolution();n.style.left=(0|i.x/o-this.offset.x)+"px",n.style.top=(0|i.y/o-this.offset.y)+"px",n.style.flip="y",r.innerText=t.label,"inherit"!=t.cursor&&null!=t.cursor&&(r.style.cursor=t.cursor),t.fontColor&&(r.style.color=t.fontColor),t.fontOpacity&&(r.style.filter="alpha(opacity="+100*t.fontOpacity+")"),t.fontFamily&&(r.style.fontFamily=t.fontFamily),t.fontSize&&(r.style.fontSize=t.fontSize),t.fontWeight&&(r.style.fontWeight=t.fontWeight),t.fontStyle&&(r.style.fontStyle=t.fontStyle),t.labelSelect===!0&&(n._featureId=e,r._featureId=e,r._geometry=i,r._geometryClass=i.CLASS_NAME),r.style.whiteSpace="nowrap",r.inset="1px,0px,0px,0px",n.parentNode||(n.appendChild(r),this.textRoot.appendChild(n));var s=t.labelAlign||"cm";1==s.length&&(s+="m");var a=r.clientWidth*OpenLayers.Renderer.VML.LABEL_SHIFT[s.substr(0,1)],l=r.clientHeight*OpenLayers.Renderer.VML.LABEL_SHIFT[s.substr(1,1)];n.style.left=parseInt(n.style.left)-a-1+"px",n.style.top=parseInt(n.style.top)+l+"px"},drawSurface:function(e,t){this.setNodeDimension(e,t);for(var i,n,r,o=this.getResolution(),s=[],a=0,l=t.components.length;l>a;a++)i=t.components[a],n=0|i.x/o-this.offset.x,r=0|i.y/o-this.offset.y,0==a%3&&0==a/3?s.push("m"):1==a%3&&s.push(" c"),s.push(" "+n+","+r);return s.push(" x e"),e.path=s.join(""),e},moveRoot:function(e){var t=this.map.getLayer(e.container.id);t instanceof OpenLayers.Layer.Vector.RootContainer&&(t=this.map.getLayer(this.container.id)),t&&t.renderer.clear(),OpenLayers.Renderer.Elements.prototype.moveRoot.apply(this,arguments),t&&t.redraw()},importSymbol:function(e){var t=this.container.id+"-"+e,i=this.symbolCache[t];if(i)return i;var n=OpenLayers.Renderer.symbol[e];if(!n)throw Error(e+" is not a valid symbol name");for(var r=new OpenLayers.Bounds(Number.MAX_VALUE,Number.MAX_VALUE,0,0),o=["m"],s=0;n.length>s;s+=2){var a=n[s],l=n[s+1];r.left=Math.min(r.left,a),r.bottom=Math.min(r.bottom,l),r.right=Math.max(r.right,a),r.top=Math.max(r.top,l),o.push(a),o.push(l),0==s&&o.push("l")}o.push("x e");var c=o.join(" "),h=(r.getWidth()-r.getHeight())/2;return h>0?(r.bottom=r.bottom-h,r.top=r.top+h):(r.left=r.left+h,r.right=r.right-h),i={path:c,size:r.getWidth(),left:r.left,bottom:r.bottom},this.symbolCache[t]=i,i},CLASS_NAME:"OpenLayers.Renderer.VML"}),OpenLayers.Renderer.VML.LABEL_SHIFT={l:0,c:.5,r:1,t:0,m:.5,b:1};