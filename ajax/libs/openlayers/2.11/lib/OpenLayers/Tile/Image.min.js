OpenLayers.Tile.Image=OpenLayers.Class(OpenLayers.Tile,{url:null,imgDiv:null,frame:null,layerAlphaHack:null,isBackBuffer:!1,isFirstDraw:!0,backBufferTile:null,maxGetUrlLength:null,initialize:function(e,t,i,n){OpenLayers.Tile.prototype.initialize.apply(this,arguments),null!=this.maxGetUrlLength&&OpenLayers.Util.extend(this,OpenLayers.Tile.Image.IFrame),this.url=n,this.frame=document.createElement("div"),this.frame.style.overflow="hidden",this.frame.style.position="absolute",this.layerAlphaHack=this.layer.alpha&&OpenLayers.Util.alphaHack()},destroy:function(){null!=this.imgDiv&&this.removeImgDiv(),this.imgDiv=null,null!=this.frame&&this.frame.parentNode==this.layer.div&&this.layer.div.removeChild(this.frame),this.frame=null,this.backBufferTile&&(this.backBufferTile.destroy(),this.backBufferTile=null),this.layer.events.unregister("loadend",this,this.resetBackBuffer),OpenLayers.Tile.prototype.destroy.apply(this,arguments)},clone:function(e){return null==e&&(e=new OpenLayers.Tile.Image(this.layer,this.position,this.bounds,this.url,this.size)),e=OpenLayers.Tile.prototype.clone.apply(this,[e]),e.imgDiv=null,e},draw:function(){this.layer!=this.layer.map.baseLayer&&this.layer.reproject&&(this.bounds=this.getBoundsFromBaseLayer(this.position));var e=OpenLayers.Tile.prototype.draw.apply(this,arguments);return-1!=OpenLayers.Util.indexOf(this.layer.SUPPORTED_TRANSITIONS,this.layer.transitionEffect)||this.layer.singleTile?e?(this.backBufferTile||(this.backBufferTile=this.clone(),this.backBufferTile.hide(),this.backBufferTile.isBackBuffer=!0,this.events.register("loadend",this,this.resetBackBuffer),this.layer.events.register("loadend",this,this.resetBackBuffer)),this.startTransition()):this.backBufferTile&&this.backBufferTile.clear():e&&this.isFirstDraw&&(this.events.register("loadend",this,this.showTile),this.isFirstDraw=!1),e?(this.isLoading?this.events.triggerEvent("reload"):(this.isLoading=!0,this.events.triggerEvent("loadstart")),this.renderTile()):!1},resetBackBuffer:function(){if(this.showTile(),this.backBufferTile&&(this.isFirstDraw||!this.layer.numLoadingTiles)){this.isFirstDraw=!1;var e=this.layer.maxExtent,t=e&&this.bounds.intersectsBounds(e,!1);t&&(this.backBufferTile.position=this.position,this.backBufferTile.bounds=this.bounds,this.backBufferTile.size=this.size,this.backBufferTile.imageSize=this.layer.getImageSize(this.bounds)||this.size,this.backBufferTile.imageOffset=this.layer.imageOffset,this.backBufferTile.resolution=this.layer.getResolution(),this.backBufferTile.renderTile()),this.backBufferTile.hide()}},renderTile:function(){return this.layer.async?(this.initImgDiv(),this.layer.getURLasync(this.bounds,this,"url",this.positionImage)):(this.url=this.layer.getURL(this.bounds),this.initImgDiv(),this.positionImage()),!0},positionImage:function(){if(null!==this.layer){OpenLayers.Util.modifyDOMElement(this.frame,null,this.position,this.size);var e=this.layer.getImageSize(this.bounds);this.layerAlphaHack?OpenLayers.Util.modifyAlphaImageDiv(this.imgDiv,null,null,e,this.url):(OpenLayers.Util.modifyDOMElement(this.imgDiv,null,null,e),this.imgDiv.src=this.url)}},clear:function(){this.imgDiv&&(this.hide(),OpenLayers.Tile.Image.useBlankTile&&(this.imgDiv.src=OpenLayers.Util.getImagesLocation()+"blank.gif"))},initImgDiv:function(){if(null==this.imgDiv){var e=this.layer.imageOffset,t=this.layer.getImageSize(this.bounds);this.imgDiv=this.layerAlphaHack?OpenLayers.Util.createAlphaImageDiv(null,e,t,null,"relative",null,null,null,!0):OpenLayers.Util.createImage(null,e,t,null,"relative",null,null,!0),OpenLayers.Util.isArray(this.layer.url)&&(this.imgDiv.urls=this.layer.url.slice()),this.imgDiv.className="olTileImage",this.frame.style.zIndex=this.isBackBuffer?0:1,this.frame.appendChild(this.imgDiv),this.layer.div.appendChild(this.frame),null!=this.layer.opacity&&OpenLayers.Util.modifyDOMElement(this.imgDiv,null,null,null,null,null,null,this.layer.opacity),this.imgDiv.map=this.layer.map;var i=function(){this.isLoading&&(this.isLoading=!1,this.events.triggerEvent("loadend"))};this.layerAlphaHack?OpenLayers.Event.observe(this.imgDiv.childNodes[0],"load",OpenLayers.Function.bind(i,this)):OpenLayers.Event.observe(this.imgDiv,"load",OpenLayers.Function.bind(i,this));var n=function(){this.imgDiv._attempts>OpenLayers.IMAGE_RELOAD_ATTEMPTS&&i.call(this)};OpenLayers.Event.observe(this.imgDiv,"error",OpenLayers.Function.bind(n,this))}this.imgDiv.viewRequestID=this.layer.map.viewRequestID},removeImgDiv:function(){OpenLayers.Event.stopObservingElement(this.imgDiv),this.imgDiv.parentNode==this.frame&&(this.frame.removeChild(this.imgDiv),this.imgDiv.map=null),this.imgDiv.urls=null;var e=this.imgDiv.firstChild;e?(OpenLayers.Event.stopObservingElement(e),this.imgDiv.removeChild(e),delete e):this.imgDiv.src=OpenLayers.Util.getImagesLocation()+"blank.gif"},checkImgURL:function(){if(this.layer){var e=this.layerAlphaHack?this.imgDiv.firstChild.src:this.imgDiv.src;OpenLayers.Util.isEquivalentUrl(e,this.url)||this.hide()}},startTransition:function(){if(this.backBufferTile&&this.backBufferTile.imgDiv){var e=1;if(this.backBufferTile.resolution&&(e=this.backBufferTile.resolution/this.layer.getResolution()),1!=e){if("resize"==this.layer.transitionEffect){var t=new OpenLayers.LonLat(this.backBufferTile.bounds.left,this.backBufferTile.bounds.top),i=new OpenLayers.Size(this.backBufferTile.size.w*e,this.backBufferTile.size.h*e),n=this.layer.map.getLayerPxFromLonLat(t);OpenLayers.Util.modifyDOMElement(this.backBufferTile.frame,null,n,i);var r=this.backBufferTile.imageSize;r=new OpenLayers.Size(r.w*e,r.h*e);var o=this.backBufferTile.imageOffset;o&&(o=new OpenLayers.Pixel(o.x*e,o.y*e)),OpenLayers.Util.modifyDOMElement(this.backBufferTile.imgDiv,null,o,r),this.backBufferTile.show()}}else this.layer.singleTile?this.backBufferTile.show():this.backBufferTile.hide()}},show:function(){this.frame.style.display="",-1!=OpenLayers.Util.indexOf(this.layer.SUPPORTED_TRANSITIONS,this.layer.transitionEffect)&&OpenLayers.IS_GECKO===!0&&(this.frame.scrollLeft=this.frame.scrollLeft)},hide:function(){this.frame.style.display="none"},CLASS_NAME:"OpenLayers.Tile.Image"}),OpenLayers.Tile.Image.useBlankTile="safari"==OpenLayers.BROWSER_NAME||"opera"==OpenLayers.BROWSER_NAME;